# Copilot Instructions for ng-brain

- **Purpose**: Engine for multi-tenant SilverBullet; separates infrastructure from user content. Core docs live in [README.md](README.md).
- **Service topology** (see [compose.yml](compose.yml)): `gatekeeper` (nginx templated), `sb-writer` (auth write), `sb-reader` (read-only), `librarian` (orchestrator), `git-watcher` (inotify Git sync). External TLS/front-door via [nginx-proxy.compose.yml](nginx-proxy.compose.yml) using nginx-proxy + acme-companion.
- **Key env**: `HOST_ROOT_DIR` must be absolute host path to repo; `SPACE_DOMAIN_SUFFIX`, `PUBLIC_HOST`, `ADMIN_HOST`, `VIRTUAL_HOST`, `LETSENCRYPT_HOST`; Git: `CONTENT_REMOTE`, `CONTENT_BRANCH` (default main), optional base64 `CONTENT_REMOTE_SSH_KEY` and `CONTENT_REMOTE_SSH_KNOWN_HOSTS`; writer creds `SB_WRITER_USER`/`SB_WRITER_PASSWORD`.
- **Content model**: Actual data in [content](content); per-space views in [spaces](spaces). [content/permissions.yaml](content/permissions.yaml) drives which paths are symlinked into each space and optional passwords.
- **Librarian workflow** (see [librarian.go](librarian.go)): runs as root (docker socket). Watches `permissions.yaml`; on change rebuilds spaces, recreates per-user containers, and reloads nginx (HUP to `ng-gatekeeper`). Always `docker rm`/`docker run` for users → expect brief downtime when config updates.
  - Symlinks: ensures shared `_plug` and `Library` exist; wipes each space before relinking. Writer gets `.git` linked; public/writer spaces are skipped for user container creation.
  - Per-user containers: image `ghcr.io/silverbulletmd/silverbullet` on network `ng-brain_default`; injects `SB_USER=<user>:<password>` when password present; Nginx conf emitted into `/etc/nginx/conf.d/<user>.conf` using `SPACE_DOMAIN_SUFFIX`.
- **Gatekeeper nginx**: Template at [nginx/nginx.conf.template](nginx/nginx.conf.template) renders with envsubst. Routes `PUBLIC_HOST` → reader, `ADMIN_HOST` → writer, wildcard `*.SPACE_DOMAIN_SUFFIX` to generated user configs; unknown spaces return bundled 404 page.
- **Git watcher** (see [scripts/git-watcher.sh](scripts/git-watcher.sh)): Alpine git + inotify. Bootstraps repo (clone or init), keeps branch in sync, auto-commits local changes on events, rebases, and on conflict pushes `conflict-YYYYMMDD-HHMMSS` then resets to remote. Supports SSH key/known-hosts via base64 env.
- **Images**: Writer built via [Dockerfile.sb](Dockerfile.sb) (adds git, sets safe directories for /content and /space). Librarian built via [Dockerfile.librarian](Dockerfile.librarian) (static Go binary with fsnotify + yaml) and can also be built locally with [run_librarian.sh](run_librarian.sh).
- **Bring-up**: After `.env` is set, `docker compose up -d` starts core stack; use `docker logs -f ng-watcher` for sync issues and `docker logs -f ng-librarian` for space orchestration. For public TLS front-door, run the companion stack defined in [nginx-proxy.compose.yml](nginx-proxy.compose.yml).
- **Adding users/paths**: Edit [content/permissions.yaml](content/permissions.yaml); librarian will rebuild, recreate containers, and reload nginx. Passwords set per space; omit password for open access. Use `/` to link all paths; otherwise list folders/files relative to repo.
- **Gotchas**: HOST_ROOT_DIR mismatch breaks bind mounts; permissions expect UID/GID 1001 inside SB containers; librarian symlink wipe means avoid storing state directly in spaces. SPACE_DOMAIN_SUFFIX must omit leading dot. Conflict branches from watcher accumulate remotely—clean manually.
- **Debug tips**: To force rebuild without file change, touch `content/permissions.yaml`. To reload nginx manually: `docker kill -s HUP ng-gatekeeper`. To recreate a user container: remove its conf in [nginx/conf.d](nginx/conf.d) and rerun librarian or edit permissions.
