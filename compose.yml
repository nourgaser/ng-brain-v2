services:
  gatekeeper:
    image: nginx:alpine
    container_name: ng-gatekeeper
    restart: always
    depends_on:
      - sb-writer
      - sb-reader
    volumes:
      - ./nginx/nginx.conf.template:/etc/nginx/nginx.conf.template:ro
      - ./nginx/login.html:/usr/share/nginx/html/login.html:ro
      - ./nginx/not_found.html:/usr/share/nginx/html/not_found.html:ro
      - ./nginx/conf.d:/etc/nginx/conf.d
    environment:
      - PUBLIC_HOST=${PUBLIC_HOST:?set PUBLIC_HOST}
      - ADMIN_HOST=${ADMIN_HOST:?set ADMIN_HOST}
      - SPACE_DOMAIN_SUFFIX=${SPACE_DOMAIN_SUFFIX:?set SPACE_DOMAIN_SUFFIX}
      - VIRTUAL_HOST=${PUBLIC_HOST:?set PUBLIC_HOST},${ADMIN_HOST:?set ADMIN_HOST},*.${SPACE_DOMAIN_SUFFIX:?set SPACE_DOMAIN_SUFFIX}
      - LETSENCRYPT_HOST=${PUBLIC_HOST:?set PUBLIC_HOST},${ADMIN_HOST:?set ADMIN_HOST},*.${SPACE_DOMAIN_SUFFIX:?set SPACE_DOMAIN_SUFFIX}
      - PORT=${GATEKEEPER_PORT:-80}
    command: >-
      /bin/sh -c "envsubst '\$$PUBLIC_HOST \$$ADMIN_HOST \$$SPACE_DOMAIN_SUFFIX' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    expose:
      - "80"
    networks:
      - default      # Talk to Writer/Reader/Alice
      - proxy-net    # Talk to Host Nginx Proxy

  sb-writer:
    build:
      context: .
      dockerfile: Dockerfile.sb
    container_name: ng-writer
    restart: always
    environment:
      - PUID=1001
      - PGID=1001
      - SB_USER=${SB_WRITER_USER:?set SB_WRITER_USER}:${SB_WRITER_PASSWORD:?set SB_WRITER_PASSWORD}
    volumes:
      # 1. The Virtual View (Where the symlinks live)
      - ./spaces/writer:/space
      # 2. The Actual Data (So the symlinks work!)
      - ./content:/content

  sb-reader:
    image: ghcr.io/silverbulletmd/silverbullet
    container_name: ng-reader
    restart: always
    environment:
      - SB_READ_ONLY=true
      - PUID=1001
      - PGID=1001
    volumes:
      - ./spaces/public:/space
      # Mount content here too, so public symlinks resolve
      - ./content:/content

  librarian:
    build:
      context: .
      dockerfile: Dockerfile.librarian
    container_name: ng-librarian
    restart: always
    user: "0:0"  # <--- MUST RUN AS ROOT to access Docker Socket!
    volumes:
      - ./content:/content
      - ./spaces:/spaces
      - /var/run/docker.sock:/var/run/docker.sock
      - ./nginx/conf.d:/etc/nginx/conf.d
    environment:
      - HOST_ROOT_DIR=${HOST_ROOT_DIR:?set HOST_ROOT_DIR}
      - SPACE_DOMAIN_SUFFIX=${SPACE_DOMAIN_SUFFIX:?set SPACE_DOMAIN_SUFFIX}

  # THE GHOST WATCHER
  # Runs 24/7. Checks for changes every 5 minutes. Commits them.
  git-watcher:
    image: alpine/git
    container_name: ng-watcher
    restart: always
    user: "1001:1001"
    environment:
      - HOME=/tmp # <--- THE FIX: Gives git a place to write global config
    volumes:
      - ./content:/repo
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "ðŸ‘» Git Watcher Started..."
        cd /repo
        
        # 1. Trust this directory (Global config written to /tmp/.gitconfig)
        git config --global --add safe.directory /repo

        # 2. Set Identity (Local config written to /repo/.git/config)
        git config user.email "watcher@ng-brain.local"
        git config user.name "Watcher Bot"

        # 3. The Loop
        while true; do
          if [ -n "$(git status --porcelain)" ]; then
             echo "ðŸ“ Changes detected. Committing..."
             git add .
             git commit -m "Auto-Snapshot: $(date '+%Y-%m-%d %H:%M:%S')"
             echo "âœ… Snapshot created."
          fi
          sleep 300
        done

networks:
  default:
    name: ng-brain_default

  proxy-net:
    external: true
    name: nginx-proxy